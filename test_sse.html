<!DOCTYPE html>
<html>
<head>
    <title>SSE Test</title>
</head>
<body>
    <h1>Testing SSE Streaming</h1>
    <button onclick="testStream()">Send Message</button>
    <div id="output"></div>
    
    <script>
    async function testStream() {
        const output = document.getElementById('output');
        output.innerHTML = 'Sending message...<br>';
        
        try {
            // First create a session
            const sessionRes = await fetch('/api/agent/chat/new', { method: 'POST' });
            const { session_id } = await sessionRes.json();
            output.innerHTML += `Session created: ${session_id}<br><br>Response:<br>`;
            
            // Send message with streaming
            const response = await fetch(`/api/agent/chat/${session_id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: 'Hello!' })
            });
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const text = decoder.decode(value);
                const lines = text.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            if (data.text) {
                                output.innerHTML += data.text;
                            }
                        } catch (e) {
                            console.warn('Parse error:', e);
                        }
                    }
                }
            }
        } catch (error) {
            output.innerHTML += `<br><br>Error: ${error.message}`;
        }
    }
    </script>
</body>
</html>
